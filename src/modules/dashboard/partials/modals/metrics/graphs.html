<div class="metrics">
	<div class="metrics-heading row">
		<div class="col-3"></div>
		<div class="col-9">
			<div class="metrics-graphs metrics-heading-graphs">
				<div class="metrics-label metrics-label-graph have-saturation">
					<span>CPU</span>
					<div class="metrics-sublabels">
						<small class="text-body-secondary">Usage</small>
						<small class="text-body-secondary">Load</small>
					</div>
				</div>
				<div class="metrics-label metrics-label-graph have-saturation">
					<span>RAM</span>
					<div class="metrics-sublabels">
						<small class="text-body-secondary">Usage</small>
						<small class="text-body-secondary">Swap</small>
					</div>
				</div>
				<div class="metrics-label metrics-label-graph have-saturation">
					<span>Disk I/O</span>
					<div class="metrics-sublabels">
						<small class="text-body-secondary">Read</small>
						<small class="text-body-secondary">Write</small>
					</div>
				</div>
				<div class="metrics-label metrics-label-graph have-saturation">
					<span>Network</span>
					<div class="metrics-sublabels">
						<small class="text-body-secondary">Rx</small>
						<small class="text-body-secondary">Tx</small>
					</div>
				</div>
			</div>
		</div>
	</div>

	<%
	const data = {};
	const hours = [];

	// Build lookup maps by timestamp for each metric
	const cpuUtilMap = new Map((grid.cpuUtil || []).map(([ts, v]) => [ts, v]));
	const cpuSatMap = new Map((grid.cpuSat || []).map(([ts, v]) => [ts, v]));
	const memUtilMap = new Map((grid.memUtil || []).map(([ts, v]) => [ts, v]));
	const memSatMap = new Map((grid.memSat || []).map(([ts, v]) => [ts, v]));
	const diskUtilMap = new Map((grid.diskUtil || []).map(([ts, v]) => [ts, v]));
	const netUtilMap = new Map((grid.netUtil || []).map(([ts, v]) => [ts, v]));

	// Collect all unique timestamps
	const allTimestamps = new Set([
		...(grid.cpuUtil || []).map(([ts]) => ts),
		...(grid.cpuSat || []).map(([ts]) => ts),
		...(grid.memUtil || []).map(([ts]) => ts),
		...(grid.memSat || []).map(([ts]) => ts),
		...(grid.diskUtil || []).map(([ts]) => ts),
		...(grid.netUtil || []).map(([ts]) => ts),
	]);

	for (const ts of allTimestamps) {
		const t = moment(ts);
		const hourKey = t.clone().startOf('hour').valueOf();
		const m = t.minute();
		if (!data[hourKey]) {
			data[hourKey] = {};
			hours.push(hourKey);
		}

		const cpuUtil = cpuUtilMap.get(ts);
		const cpuSat = cpuSatMap.get(ts);
		const memUtil = memUtilMap.get(ts);
		const memSat = memSatMap.get(ts);
		const diskUtil = diskUtilMap.get(ts);
		const netUtil = netUtilMap.get(ts);

		// Disk raw is now { total, read, write } (bytes/s)
		const diskRaw = diskUtil?.raw || {};
		const diskTotal = diskRaw.total || 0;
		const diskNorm = diskUtil?.normalized || 0;
		// Derive per-direction normalized values proportionally from the total
		const diskReadNorm = diskTotal > 0 ? diskNorm * ((diskRaw.read || 0) / diskTotal) : 0;
		const diskWriteNorm = diskTotal > 0 ? diskNorm * ((diskRaw.write || 0) / diskTotal) : 0;

		// Network raw is now { total, rx, tx } (bytes/s)
		const netRaw = netUtil?.raw || {};
		const netTotal = netRaw.total || 0;
		const netNorm = netUtil?.normalized || 0;
		// Derive per-direction normalized values proportionally from the total
		const netRxNorm = netTotal > 0 ? netNorm * ((netRaw.rx || 0) / netTotal) : 0;
		const netTxNorm = netTotal > 0 ? netNorm * ((netRaw.tx || 0) / netTotal) : 0;

		data[hourKey][m] = {
			ts: ts,
			cpuUtil: cpuUtil?.normalized || 0,
			cpuRaw: cpuUtil?.raw || {},
			cpuSat: cpuSat?.normalized || 0,
			cpuSatRaw: cpuSat?.raw || 0,
			memUtil: memUtil?.normalized || 0,
			memRaw: memUtil?.raw || {},
			memSat: memSat?.normalized || 0,
			memSatRaw: memSat?.raw || 0,
			diskUtil: diskNorm,
			diskRaw: diskRaw,
			diskReadNorm: diskReadNorm,
			diskWriteNorm: diskWriteNorm,
			netUtil: netNorm,
			netRaw: netRaw,
			netRxNorm: netRxNorm,
			netTxNorm: netTxNorm
		};
	}

	hours.sort((a, b) => b - a);
	const now = moment();
	const currentHourKey = now.clone().startOf('hour').valueOf();
	const currentMinute = now.minute();
	let lastDateStr = null;
	%>
	<%for (const hourKey of hours) {%>
		<%const t = moment(hourKey)%>
		<%const dateStr = t.format('MMMM D, YYYY')%>
		<%const isCompressed = _.isUndefined(_.find(toggledRows, { date: t.format('YYYY-MM-DD'), time: t.format('HH:mm') }))%>
		<%if (dateStr !== lastDateStr) {%>
			<%if (lastDateStr !== null) {%>
				</div>
			<%}%>
			<div class="metrics-day">
				<h6><%=dateStr%></h6>
			<%lastDateStr = dateStr%>
		<%}%>
		<div class="metrics-hour <%=(isCompressed ? 'metrics-hour-compressed' : '')%> row">
			<a href="#" class="metrics-events col-3 text-dark text-decoration-none" data-date="<%=t.format('YYYY-MM-DD')%>" data-time="<%=t.format('HH:mm')%>">
				<div class="d-flex align-items-center">
					<i class="icon-solid <%=(isCompressed ? 'icon-square-plus' : 'icon-square-minus')%> icon-fw text-gray-500"></i>
					<small class="font-monospace"><%=t.format('HH:mm')%></small>
				</div>
			</a>
			<div class="metrics-minutes col-9">
				<%const maxMinute = (hourKey === currentHourKey) ? currentMinute : 59%>
				<%for (let m = maxMinute; m >= 0; m--) {%>
					<%const d = data[hourKey][m] || {}%>
					<%
					const tooltipContent = d.ts ? `
						<div class=&quot;text-start&quot;>
							<div class=&quot;fw-semibold mb-2 text-nowrap&quot;>${moment(d.ts).format('HH:mm')}</div>
							<div class=&quot;text-nowrap&quot;>CPU: nice ${Math.round((d.cpuRaw.nice || 0) * 100)}%, user ${Math.round((d.cpuRaw.user || 0) * 100)}%, sys ${Math.round((d.cpuRaw.sys || 0) * 100)}%</div>
							<div class=&quot;text-nowrap&quot;>Load: ${typeof d.cpuSatRaw === 'number' ? d.cpuSatRaw.toFixed(2) : 0}</div>
							<div class=&quot;text-nowrap mt-2&quot;>Memory: ${d.memRaw.used ? prettyBytes(d.memRaw.used, { binary: true }) : 'N/A'} / ${d.memRaw.total ? prettyBytes(d.memRaw.total, { binary: true }) : 'N/A'}</div>
							<div class=&quot;text-nowrap&quot;>Swap out: ${typeof d.memSatRaw === 'number' ? d.memSatRaw.toFixed(1) : 0} pages/s</div>
							<div class=&quot;text-nowrap mt-2&quot;>Disk I/O: ${d.diskRaw.total ? prettyBytes(d.diskRaw.total, { binary: true }) : 'N/A'}</div>
							<div class=&quot;text-nowrap&quot;>Read: ${d.diskRaw.read ? prettyBytes(d.diskRaw.read, { binary: true }) : 'N/A'} · Write: ${d.diskRaw.write ? prettyBytes(d.diskRaw.write, { binary: true }) : 'N/A'}</div>
							<div class=&quot;text-nowrap mt-2&quot;>Network: ${d.netRaw.total ? prettyBytes(d.netRaw.total, { binary: true }) + '/s' : 'N/A'}</div>
							<div class=&quot;text-nowrap&quot;>Rx: ${d.netRaw.rx ? prettyBytes(d.netRaw.rx, { binary: true }) + '/s' : 'N/A'} · Tx: ${d.netRaw.tx ? prettyBytes(d.netRaw.tx, { binary: true }) + '/s' : 'N/A'}</div>
						</div>
					`.replace(/\s+/g, ' ').trim() : '';
					%>
					<div class="metrics-minute" data-minute="<%=m%>" data-bs-toggle="tooltip" data-bs-placement="left" data-bs-custom-class="metrics-tooltip" data-bs-original-title="<%=tooltipContent%>">
						<div class="metrics-graphs">
							<div class="metrics-data metrics-data-cpu valid-data have-saturation">
								<div class="polygon-use compressed" style="--utilization: <%=d.cpuUtil || 0%>;"></div>
								<div class="polygon-sat compressed" style="--saturation: <%=d.cpuSat || 0%>;"></div>
							</div>
							<div class="metrics-data metrics-data-memory valid-data have-saturation">
								<div class="polygon-use compressed" style="--utilization: <%=d.memUtil || 0%>;"></div>
								<div class="polygon-sat compressed" style="--saturation: <%=d.memSat || 0%>;"></div>
							</div>
							<div class="metrics-data metrics-data-disks valid-data have-saturation">
								<div class="polygon-use compressed" style="--utilization: <%=d.diskReadNorm || 0%>;"></div>
								<div class="polygon-sat compressed" style="--saturation: <%=d.diskWriteNorm || 0%>;"></div>
							</div>
							<div class="metrics-data metrics-data-network valid-data have-saturation">
								<div class="polygon-use compressed" style="--utilization: <%=d.netRxNorm || 0%>;"></div>
								<div class="polygon-sat compressed" style="--saturation: <%=d.netTxNorm || 0%>;"></div>
							</div>
						</div>
					</div>
				<%}%>
			</div>
		</div>
	<%}%>
	<%if (lastDateStr !== null) {%>
		</div>
	<%}%>
</div>

<div class="d-flex flex-column justify-content-center align-items-center h-100 d-none">
	<p class="text-center">Metrics collection is currently enabled.<br>If disabled, you won't be able to monitor system health or track performance metrics.</p>
	<u-button variant="danger" data-action="disable" loading-text="Disabling...">Disable metrics</u-button>
</div>
