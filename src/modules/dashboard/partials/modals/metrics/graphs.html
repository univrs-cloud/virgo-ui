<div class="metrics">
	<div class="metrics-heading row">
		<div class="col-3"></div>
		<div class="col-9">
			<div class="metrics-graphs metrics-heading-graphs">
				<div class="metrics-label metrics-label-graph have-saturation">
					<span>CPU</span>
					<div class="metrics-sublabels">
						<small class="text-body-secondary">Usage</small>
						<small class="text-body-secondary">Load</small>
					</div>
				</div>
				<div class="metrics-label metrics-label-graph have-saturation">
					<span>RAM</span>
					<div class="metrics-sublabels">
						<small class="text-body-secondary">Usage</small>
						<small class="text-body-secondary">Swap</small>
					</div>
				</div>
				<div class="metrics-label metrics-label-graph">
					<span>Disk I/O</span>
					<div class="metrics-sublabels">
						<small class="text-body-secondary">Usage</small>
					</div>
				</div>
				<div class="metrics-label metrics-label-graph">
					<span>Network</span>
					<div class="metrics-sublabels">
						<small class="text-body-secondary">Usage</small>
					</div>
				</div>
			</div>
		</div>
	</div>

	<%
	const data = {};
	const hours = [];
	for (let i = 0; i < (grid.cpuUtil?.length || 0); i++) {
		const ts = grid.cpuUtil[i][0];
		const t = moment(ts);
		const hourKey = t.clone().startOf('hour').valueOf();
		const m = t.minute();
		if (!data[hourKey]) {
			data[hourKey] = {};
			hours.push(hourKey);
		}
		data[hourKey][m] = {
			ts: ts,
			cpuUtil: grid.cpuUtil[i][1]?.normalized || 0,
			cpuRaw: grid.cpuUtil[i][1]?.raw || {},
			cpuSat: grid.cpuSat?.[i]?.[1]?.normalized || 0,
			cpuSatRaw: grid.cpuSat?.[i]?.[1]?.raw || 0,
			memUtil: grid.memUtil?.[i]?.[1]?.normalized || 0,
			memRaw: grid.memUtil?.[i]?.[1]?.raw || {},
			memSat: grid.memSat?.[i]?.[1]?.normalized || 0,
			memSatRaw: grid.memSat?.[i]?.[1]?.raw || 0,
			diskUtil: grid.diskUtil?.[i]?.[1]?.normalized || 0,
			diskRaw: grid.diskUtil?.[i]?.[1]?.raw || 0,
			netUtil: grid.netUtil?.[i]?.[1]?.normalized || 0,
			netRaw: grid.netUtil?.[i]?.[1]?.raw || 0
		};
	}
	hours.reverse();
	const now = moment();
	const currentHourKey = now.clone().startOf('hour').valueOf();
	const currentMinute = now.minute();
	let lastDateStr = null;
	%>
	<%for (const hourKey of hours) {%>
		<%const t = moment(hourKey)%>
		<%const dateStr = t.format('MMMM D, YYYY')%>
		<%const isCompressed = _.isUndefined(_.find(toggledRows, { date: t.format('YYYY-MM-DD'), time: t.format('HH:mm') }))%>
		<%if (dateStr !== lastDateStr) {%>
			<%if (lastDateStr !== null) {%>
				</div>
			<%}%>
			<div class="metrics-day">
				<h6><%=dateStr%></h6>
			<%lastDateStr = dateStr%>
		<%}%>
		<div class="metrics-hour <%=(isCompressed ? 'metrics-hour-compressed' : '')%> row">
			<a href="#" class="metrics-events col-3 text-dark text-decoration-none" data-date="<%=t.format('YYYY-MM-DD')%>" data-time="<%=t.format('HH:mm')%>">
				<i class="icon-solid <%=(isCompressed ? 'icon-angle-right' : 'icon-angle-down')%> icon-fw"></i>
				<small class="font-monospace"><%=t.format('HH:mm')%></small>
			</a>
			<div class="metrics-minutes col-9">
				<%const maxMinute = (hourKey === currentHourKey) ? currentMinute : 59%>
				<%for (let m = maxMinute; m >= 0; m--) {%>
					<%const d = data[hourKey][m] || {}%>
					<div class="metrics-minute" data-minute="<%=m%>">
						<div class="metrics-graphs">
							<div class="metrics-data metrics-data-cpu valid-data have-saturation">
								<div class="polygon-use compressed" style="--utilization: <%=d.cpuUtil || 0%>;"></div>
								<div class="polygon-sat compressed" style="--saturation: <%=d.cpuSat || 0%>;"></div>
							</div>
							<div class="metrics-data metrics-data-memory valid-data have-saturation">
								<div class="polygon-use compressed" style="--utilization: <%=d.memUtil || 0%>;"></div>
								<div class="polygon-sat compressed" style="--saturation: <%=d.memSat || 0%>;"></div>
							</div>
							<div class="metrics-data metrics-data-disks valid-data">
								<div class="polygon-use compressed" style="--utilization: <%=d.diskUtil || 0%>;"></div>
							</div>
							<div class="metrics-data metrics-data-network valid-data">
								<div class="polygon-use compressed" style="--utilization: <%=d.netUtil || 0%>;"></div>
							</div>
						</div>
						<%if (d.ts) {%>
							<div class="metrics-tooltip">
								<div class="metrics-tooltip-time"><%=moment(d.ts).format('HH:mm')%></div>
								<div class="metrics-tooltip-row">CPU usage: nice: <%=Math.round((d.cpuRaw.nice || 0) * 100)%>%, user: <%=Math.round((d.cpuRaw.user || 0) * 100)%>%, sys: <%=Math.round((d.cpuRaw.sys || 0) * 100)%>%</div>
								<div class="metrics-tooltip-row">Load: <%=typeof d.cpuSatRaw === 'number' ? d.cpuSatRaw.toFixed(2) : 0%></div>
								<div class="metrics-tooltip-row">Memory usage: <%=d.memRaw.used ? prettyBytes(d.memRaw.used, { binary: true }) : 'N/A'%> / <%=d.memRaw.total ? prettyBytes(d.memRaw.total, { binary: true }) : 'N/A'%></div>
								<div class="metrics-tooltip-row">Swap out: <%=d.memSatRaw || 0%> pages</div>
								<div class="metrics-tooltip-row">Disk I/O: <%=d.diskRaw ? prettyBytes(d.diskRaw, { binary: true }) + '/s' : 'N/A'%></div>
								<div class="metrics-tooltip-row">Network I/O: <%=d.netRaw ? prettyBytes(d.netRaw, { binary: true }) + '/s' : 'N/A'%></div>
							</div>
						<%}%>
					</div>
				<%}%>
			</div>
		</div>
	<%}%>
	<%if (lastDateStr !== null) {%>
		</div>
	<%}%>
</div>

<div class="d-flex flex-column justify-content-center align-items-center h-100 d-none">
	<p class="text-center">Metrics collection is currently enabled.<br>If disabled, you won't be able to monitor system health or track performance metrics.</p>
	<u-button variant="danger" data-action="disable" loading-text="Disabling...">Disable metrics</u-button>
</div>
