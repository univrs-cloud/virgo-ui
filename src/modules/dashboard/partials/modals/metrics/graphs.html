<div class="metrics">
	<div class="metrics-heading row">
		<div class="col-3"></div>
		<div class="col-9">
			<div class="metrics-graphs metrics-heading-graphs">
				<div class="metrics-label metrics-label-graph have-saturation">
					<span>CPU</span>
					<div class="metrics-sublabels">
						<small class="text-body-secondary">Usage</small>
						<small class="text-body-secondary">Load</small>
					</div>
				</div>
				<div class="metrics-label metrics-label-graph have-saturation">
					<span>RAM</span>
					<div class="metrics-sublabels">
						<small class="text-body-secondary">Usage</small>
						<small class="text-body-secondary">Swap</small>
					</div>
				</div>
				<div class="metrics-label metrics-label-graph">
					<span>Disk I/O</span>
					<div class="metrics-sublabels">
						<small class="text-body-secondary">Usage</small>
					</div>
				</div>
				<div class="metrics-label metrics-label-graph">
					<span>Network</span>
					<div class="metrics-sublabels">
						<small class="text-body-secondary">Usage</small>
					</div>
				</div>
			</div>
		</div>
	</div>

	<%
	// Convert [timestamp, value] arrays to Maps for O(1) lookup
	const toMap = (arr) => {
		if (!arr || !Array.isArray(arr)) return new Map();
		return new Map(arr);
	};
	
	const cpuUtilMap = toMap(grid.cpuUtil);
	const cpuSatMap = toMap(grid.cpuSat);
	const memUtilMap = toMap(grid.memUtil);
	const memSatMap = toMap(grid.memSat);
	const diskUtilMap = toMap(grid.diskUtil);
	const netUtilMap = toMap(grid.netUtil);
	
	const getMetric = (map, timestamp) => {
		return map.get(timestamp) ?? null;
	};
	
	const isValid = (value) => {
		return value !== null && value !== undefined;
	};
	
	// Collect all unique timestamps from all metrics
	const allTimestamps = new Set([
		...cpuUtilMap.keys(),
		...cpuSatMap.keys(),
		...memUtilMap.keys(),
		...memSatMap.keys(),
		...diskUtilMap.keys(),
		...netUtilMap.keys()
	]);
	
	// Group timestamps by hour (floor to hour boundary)
	const hourGroups = new Map();
	for (const ts of allTimestamps) {
		const hourKey = moment(ts).startOf('hour').valueOf();
		if (!hourGroups.has(hourKey)) {
			hourGroups.set(hourKey, []);
		}
		hourGroups.get(hourKey).push(ts);
	}
	
	// Sort hours descending (most recent first)
	const sortedHours = [...hourGroups.keys()].sort((a, b) => b - a);
	
	let lastDateStr = null;
	%>
	<%for (const hourKey of sortedHours) {%>
		<%
		const currentTime = moment(hourKey);
		const dateStr = currentTime.format('MMMM D, YYYY');
		const minuteTimestamps = hourGroups.get(hourKey).sort((a, b) => b - a);
		%>
		
		<%if (dateStr !== lastDateStr) {%>
			<%if (lastDateStr !== null) {%>
				</div>
			<%}%>
			<div class="metrics-day">
				<h6><%=dateStr%></h6>
				<%lastDateStr = dateStr%>
		<%}%>
		
		<div class="metrics-hour metrics-hour-compressed row">
			<div class="metrics-events col-3">
				<small class="font-monospace"><%=currentTime.format('HH:mm')%></small>
			</div>
			<div class="metrics-minutes col-9">
				<%for (const minuteTimestamp of minuteTimestamps) {%>
					<%
					const m = moment(minuteTimestamp).minute();
					const cpuUtil = getMetric(cpuUtilMap, minuteTimestamp);
					const cpuSat = getMetric(cpuSatMap, minuteTimestamp);
					const memUtil = getMetric(memUtilMap, minuteTimestamp);
					const memSat = getMetric(memSatMap, minuteTimestamp);
					const diskUtil = getMetric(diskUtilMap, minuteTimestamp);
					const netUtil = getMetric(netUtilMap, minuteTimestamp);
					%>
					<div class="metrics-minute" data-minute="<%=m%>">
						<div class="metrics-graphs">
							<div class="metrics-data metrics-data-cpu <%=isValid(cpuUtil) ? 'valid-data' : ''%> have-saturation">
								<%if (isValid(cpuUtil)) {%>
									<div class="polygon-use compressed" style="--utilization: <%=cpuUtil%>;"></div>
									<div class="polygon-sat compressed" style="--saturation: <%=cpuSat || 0%>;"></div>
								<%}%>
							</div>
							<div class="metrics-data metrics-data-memory <%=isValid(memUtil) ? 'valid-data' : ''%> have-saturation">
								<%if (isValid(memUtil)) {%>
									<div class="polygon-use compressed" style="--utilization: <%=memUtil%>;"></div>
									<div class="polygon-sat compressed" style="--saturation: <%=memSat || 0%>;"></div>
								<%}%>
							</div>
							<div class="metrics-data metrics-data-disks <%=isValid(diskUtil) ? 'valid-data' : ''%>">
								<%if (isValid(diskUtil)) {%>
									<div class="polygon-use compressed" style="--utilization: <%=diskUtil%>;"></div>
								<%}%>
							</div>
							<div class="metrics-data metrics-data-network <%=isValid(netUtil) ? 'valid-data' : ''%>">
								<%if (isValid(netUtil)) {%>
									<div class="polygon-use compressed" style="--utilization: <%=netUtil%>;"></div>
								<%}%>
							</div>
						</div>
					</div>
				<%}%>
			</div>
		</div>
	<%}%>
	<%if (lastDateStr !== null) {%>
		</div>
	<%}%>
</div>

<div class="d-flex flex-column justify-content-center align-items-center h-100 d-none">
	<p class="text-center">Metrics collection is currently enabled.<br>If disabled, you won't be able to monitor system health or track performance metrics.</p>
	<u-button variant="danger" class="disable" loading-text="Disabling...">Disable metrics</u-button>
</div>
